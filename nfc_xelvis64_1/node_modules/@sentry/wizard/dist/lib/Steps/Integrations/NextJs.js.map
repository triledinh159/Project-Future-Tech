{"version":3,"file":"NextJs.js","sourceRoot":"","sources":["../../../../lib/Steps/Integrations/NextJs.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from 'fs';\nimport { Answers, prompt } from 'inquirer';\nimport * as _ from 'lodash';\nimport * as path from 'path';\nimport { clean, gte, minVersion, satisfies, validRange } from 'semver';\n\nimport { Args } from '../../Constants';\nimport { debug, green, l, nl, red } from '../../Helper/Logging';\nimport { SentryCli, SentryCliProps } from '../../Helper/SentryCli';\nimport { BaseIntegration } from './BaseIntegration';\n\nconst MIN_NEXTJS_VERSION = '10.0.8'; // Must be a fixed version: `X.Y.Z`\nconst PROPERTIES_FILENAME = 'sentry.properties';\nconst SENTRYCLIRC_FILENAME = '.sentryclirc';\nconst GITIGNORE_FILENAME = '.gitignore';\nconst CONFIG_DIR = 'configs/';\nconst MERGEABLE_CONFIG_PREFIX = '_';\n\nlet appPackage: any = {};\n\ntry {\n  appPackage = require(path.join(process.cwd(), 'package.json'));\n} catch {\n  // We don't need to have this\n}\n\nexport class NextJs extends BaseIntegration {\n  protected _sentryCli: SentryCli;\n\n  constructor(protected _argv: Args) {\n    super(_argv);\n    this._sentryCli = new SentryCli(this._argv);\n  }\n\n  public async emit(answers: Answers): Promise<Answers> {\n    const dsn = _.get(answers, ['config', 'dsn', 'public'], null);\n    nl();\n\n    const sentryCliProps = this._sentryCli.convertAnswersToProperties(answers);\n    await this._createSentryCliConfig(sentryCliProps);\n\n    const configDirectory = path.join(\n      __dirname,\n      '..',\n      '..',\n      '..',\n      'NextJs',\n      CONFIG_DIR,\n    );\n\n    if (fs.existsSync(configDirectory)) {\n      this._createNextConfig(configDirectory, dsn);\n    } else {\n      debug(\n        `Couldn't find ${configDirectory}, probably because you run from src`,\n      );\n      nl();\n    }\n\n    l(\n      'For more information, see https://docs.sentry.io/platforms/javascript/guides/nextjs/',\n    );\n    nl();\n\n    return {};\n  }\n\n  public async shouldConfigure(_answers: Answers): Promise<Answers> {\n    if (this._shouldConfigure) {\n      return this._shouldConfigure;\n    }\n\n    nl();\n\n    let userAnswers: Answers = { continue: true };\n    if (!this._checkDep('next', true) && !this._argv.quiet) {\n      userAnswers = await prompt({\n        message:\n          'There were errors during your project checkup, do you still want to continue?',\n        name: 'continue',\n        default: false,\n        type: 'confirm',\n      });\n    }\n\n    nl();\n\n    if (!userAnswers['continue']) {\n      throw new Error('Please install the required dependencies to continue.');\n    }\n\n    this._shouldConfigure = Promise.resolve({ nextjs: true });\n    // eslint-disable-next-line @typescript-eslint/unbound-method\n    return this.shouldConfigure;\n  }\n\n  private async _createSentryCliConfig(\n    cliProps: SentryCliProps,\n  ): Promise<void> {\n    const { 'auth/token': authToken, ...cliPropsToWrite } = cliProps;\n\n    /**\n     * To not commit the auth token to the VCS, instead of adding it to the\n     * properties file (like the rest of props), it's added to the Sentry CLI\n     * config, which is added to the gitignore. This way makes the properties\n     * file safe to commit without exposing any auth tokens.\n     */\n    if (authToken) {\n      try {\n        await fs.promises.appendFile(\n          SENTRYCLIRC_FILENAME,\n          this._sentryCli.dumpConfig({ auth: { token: authToken } }),\n        );\n        green(`✓ Successfully added the auth token to ${SENTRYCLIRC_FILENAME}`);\n      } catch {\n        red(\n          `⚠ Could not add the auth token to ${SENTRYCLIRC_FILENAME}, ` +\n            `please add it to identify your user account:\\n${authToken}`,\n        );\n        nl();\n      }\n    } else {\n      red(\n        `⚠ Did not find an auth token, please add your token to ${SENTRYCLIRC_FILENAME}`,\n      );\n      l(\n        'To generate an auth token, visit https://sentry.io/settings/account/api/auth-tokens/',\n      );\n      l(\n        'To learn how to configure Sentry CLI, visit ' +\n          'https://docs.sentry.io/platforms/javascript/guides/nextjs/manual-setup/#configure-sentry-cli',\n      );\n    }\n\n    await this._addToGitignore(\n      SENTRYCLIRC_FILENAME,\n      `⚠ Could not add ${SENTRYCLIRC_FILENAME} to ${GITIGNORE_FILENAME}, ` +\n        'please add it to not commit your auth key.',\n    );\n\n    try {\n      await fs.promises.writeFile(\n        `./${PROPERTIES_FILENAME}`,\n        this._sentryCli.dumpProperties(cliPropsToWrite),\n      );\n      green(`✓ Successfully created sentry.properties`);\n    } catch {\n      red(`⚠ Could not add org and project data to ${PROPERTIES_FILENAME}`);\n      l(\n        'See docs for a manual setup: https://docs.sentry.io/platforms/javascript/guides/nextjs/manual-setup/#configure-sentry-cli',\n      );\n    }\n    nl();\n  }\n\n  private async _addToGitignore(\n    filepath: string,\n    errorMsg: string,\n  ): Promise<void> {\n    /**\n     * Don't check whether the given file is ignored because:\n     * 1. It's tricky to check it without git.\n     * 2. Git might not be installed or accessible.\n     * 3. It's convenient to use a module to interact with git, but it would\n     *    increase the size x2 approximately. Docs say to run the Wizard without\n     *    installing it, and duplicating the size would slow the set-up down.\n     * 4. The Wizard is meant to be run once.\n     * 5. A message is logged informing users it's been added to the gitignore.\n     * 6. It will be added to the gitignore as many times as it runs - not a big\n     *    deal.\n     * 7. It's straightforward to remove it from the gitignore.\n     */\n    try {\n      await fs.promises.appendFile(\n        GITIGNORE_FILENAME,\n        `\\n# Sentry\\n${filepath}\\n`,\n      );\n      green(`✓ ${filepath} added to ${GITIGNORE_FILENAME}`);\n    } catch {\n      red(errorMsg);\n    }\n  }\n\n  private _createNextConfig(configDirectory: string, dsn: any): void {\n    const templates = fs.readdirSync(configDirectory);\n    for (const template of templates) {\n      this._setTemplate(configDirectory, template, dsn);\n    }\n    red(\n      '⚠ Performance monitoring is enabled capturing 100% of transactions.\\n' +\n        '  Learn more in https://docs.sentry.io/product/performance/',\n    );\n    nl();\n  }\n\n  private _setTemplate(\n    configDirectory: string,\n    template: string,\n    dsn: string,\n  ): void {\n    const templatePath = path.join(configDirectory, template);\n    const mergeableFile = MERGEABLE_CONFIG_PREFIX + template;\n    if (!fs.existsSync(template)) {\n      this._fillAndCopyTemplate(templatePath, template, dsn);\n    } else if (!fs.existsSync(mergeableFile)) {\n      this._fillAndCopyTemplate(templatePath, mergeableFile, dsn);\n      red(\n        `File ${template} already exists, so created ${mergeableFile}.\\n` +\n          `Please, merge those files.`,\n      );\n      nl();\n    } else {\n      red(\n        `File ${template} already exists, and ${mergeableFile} also exists.\\n` +\n          'Please, merge those files.',\n      );\n      nl();\n    }\n  }\n\n  private _fillAndCopyTemplate(\n    sourcePath: string,\n    targetPath: string,\n    dsn: string,\n  ): void {\n    const templateContent = fs.readFileSync(sourcePath).toString();\n    const filledTemplate = templateContent.replace('___DSN___', dsn);\n    fs.writeFileSync(targetPath, filledTemplate);\n  }\n\n  private _checkDep(packageName: string, minVersion?: boolean): boolean {\n    const depVersion = _.get(\n      appPackage,\n      ['dependencies', packageName],\n      '0.0.0',\n    );\n    const devDepVersion = _.get(\n      appPackage,\n      ['devDependencies', packageName],\n      '0.0.0',\n    );\n\n    if (\n      !_.get(appPackage, `dependencies.${packageName}`, false) &&\n      !_.get(appPackage, `devDependencies.${packageName}`, false)\n    ) {\n      red(`✗ ${packageName} isn't in your dependencies`);\n      red(`  please install it with yarn/npm`);\n      return false;\n    } else if (\n      !this._fulfillsMinVersion(depVersion) &&\n      !this._fulfillsMinVersion(devDepVersion)\n    ) {\n      red(\n        `✗ Your installed version of \\`${packageName}\\` is not supported, >=${MIN_NEXTJS_VERSION} needed.`,\n      );\n      return false;\n    } else {\n      if (minVersion) {\n        green(`✓ ${packageName} >= ${MIN_NEXTJS_VERSION} is installed`);\n      } else {\n        green(`✓ ${packageName} is installed`);\n      }\n      return true;\n    }\n  }\n\n  private _fulfillsMinVersion(version: string): boolean {\n    // The latest version, which at the moment is greater than the minimum\n    // version, shouldn't be a blocker in the wizard.\n    if (version === 'latest') {\n      return true;\n    }\n\n    const cleanedVersion = clean(version);\n    if (cleanedVersion) {\n      // gte(x, y) : true if x >= y\n      return gte(cleanedVersion, MIN_NEXTJS_VERSION);\n    }\n\n    const minVersionRange = `>=${MIN_NEXTJS_VERSION}`;\n    const userVersionRange = validRange(version);\n    const minUserVersion = minVersion(userVersionRange);\n    if (minUserVersion == null) {\n      // This should never happen\n      return false;\n    }\n    return satisfies(minUserVersion, minVersionRange);\n  }\n}\n"]}